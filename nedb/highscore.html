<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.js"></script>
  <script src="./nedb.min.js"></script>
  <script>

    let highscoreAnz = 3;  // Anzahl Highscores
    let db;                // Datenbank

    let highscoreText = "";
    let hsmin = 0;        // minimaler Highscore
    let score = 0;        // aktueller score
    let name = "";        // Spielername f√ºr Highscore

    let state = "PLAY";

    function preload() {
      db = new Nedb({ filename: 'highscore' });   // im Browser-Storage: IndexedDB
      db.loadDatabase();
      //db.remove({}, { multi: true });  
      db.count({}, function (err, res) {
        if (res === 0) {
          for (let i = 0; i < highscoreAnz; i++) {
            db.insert([{ name: "N.N", score: 0 }]);
          }
        }
        getHighscore();
      });
    }

    function setup() {
      createCanvas(300, 200);
    }

    function getHighscore() {

      db.find({}).sort({
        score: -1                                 // Nach score absteigend sortieren
      }).exec(function (err, res) {              // res ist das Array mit den Resultaten der Abfrage
        if (res.length > highscoreAnz) {
          for (let i = highscoreAnz; i < res.length; i++) {
            db.remove({ _id: res[i]._id });
          }
          res = res.slice(0, highscoreAnz);
        }

        highscoreText = "Highscore:\n\n";
        for (let i = 0; i < res.length; i++) {
          highscoreText += res[i].name + ": " + res[i].score + "\n";
        }
        hsmin = res[res.length - 1].score;

      });
    }


    function draw() {
      background(220);
      text(highscoreText, 50, 30);

      text("Deine Zahl: " + score, 50, 140);

      if (score > hsmin) {
        state = "EINGABE";
        text("Dein Name: " + name, 50, 165);
      }
    }

    function keyTyped() {
      if (state === "EINGABE") {
        name += key;
      }
    }

    function keyPressed() {
      if (state === "EINGABE") {
        if (keyCode === BACKSPACE) name = name.substr(0, name.length - 1);
        if (keyCode === ENTER) {
          let data = {
            name: name,
            score: score
          };
          db.insert([data], function (res) {
            score = 0;
            name = "";
            state = "PLAY";
            getHighscore();
          });
        }
      }
    }

    function mousePressed() {
      if (state === "PLAY") {
        score = int(random(50));
      }
    }

  </script>
</head>

<body>
</body>

</html>